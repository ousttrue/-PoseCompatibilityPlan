# retarget

## pose とは

* ある骨格に対する回転差分の集合

## 骨格とは

* joint の集合
* 各 joint の初期姿勢でのワールド位置
* 各 joint の初期姿勢での向き

## retarget とは

* 異なる骨格間で同じ姿勢になるようにポーズを変換する

## 同じ姿勢とは

* すべての {term}`ヒューマンボーン` が同じ向き
* {term}`TPose` から初期姿勢でのヒューマンボーンの向きが `だいたい` わかる

故に TPose に変換してから同じ {term}`Pose` を適用することで同じ姿勢ということにしてた。
TPose 時に

* 親指が斜め
* 肩の上がり下がり具合
* 足が内股、蟹股、開き具合
* 猫背、反り腰

等の TPose 時の個体差が混入する。

## 厳格な TPose の定義を作ろう

作った。

```{figure} logic.jpg
すべてのボーンが `完全に` ワールド軸平行
```

以下の情報で TPose が記述される。

* 各ボーンの長さ
* 非接続ボーン(hips, upperLeg, upperSholder, 各指)の開始位置

## joint から bone への拡張

* すべての{term}`ヒューマンボーン` を head-tail のペアにしてロール軸を明示
* 追加のupベクトルも定義することで３次元姿勢を一意に表現できるようにする

ボーンの姿勢が同じを `人間の骨が同じ向き` と解釈できるようにする。

## これではモデルの個性が失われるのでは ?

* 曖昧TPose から 厳格TPose への差分を pose として得ることができるのでこれを加味すればよい(たぶん)
* ポーズに姿勢の個性が入っているか否かで切り分けできるかもしれない
* アプリ内で内部変換用に使うもので、この状態でエクスポートすることは想定していません

## 姿勢は、`受け入れ骨格 + ポーズの組` で表される

例えば、mmd のポーズを厳格TPose化すると

`vpd + 受け入れpmd` => `正規化ポーズに対する相対回転 + 厳格TPoseに変換されたpmd`

となり左と右のポーズ適用結果は完全に一致している。
正規化ポーズには 受け入れ pmd と 厳格TPose の差分が含まれる。
受け入れpmdの姿勢の個性が正規化ポーズに移動する。

ここで、

`正規化ポーズに対する相対回転 + 厳格TPoseのCPUモデル`

というように受け入れ骨格を入れ替えると他モデルに対するリターゲットが発生する。

```{figure} thumb.gif
他モデルリターゲット例
```

## 同モデルに対するリターゲット

同じモデルで

* 初期姿勢が違う
* ローカル軸が違う

に対してポーズ, SpringBone, Constraint のパラメーター変換の問題。
VRMの正規化の前後で発生する。

## 異モデルに対するリターゲット

ポーズをモデル間で共有する際に発生。
この時の基準ポーズを厳格TPoseにできないか実験している。

* ポーズ自体を流通させることができる
* 曖昧TPose から 厳格TPose への変換は親指の正確さなどを除けば機械的にできる

## できること

* 厳格TPose は 曖昧TPose や Aスタンスからプログラムで機械的に作れる(納品物は曖昧TPoseでよい)
* すべてのヒューマンボーンの向きが完全に確定する
* 曖昧だった親指を補正する余地が生まれる
    * プログラムからの入力ポーズがよろしくない(親指の第2, 3関節に対して yaw, roll してる)
    * 受け入れ側のモデルのロール軸がずれている
    * 切り分ける
* 厳格TPose に対するポーズを、ポーズの標準フォーマットにできるのでは？
    * 便利な bvh
    * mmd とは路線が異なる。mmd はリグに対するキーフレームアニメーションなのでレイヤーが異なる
        * FK のフルフレームモーションが想定されるので下のレイヤー

## 自動化に必要な追加情報

* ヒューマンボーンの先端を示す empty joint(head, toes, 各指)
* 親指などのポールターゲットもしくはローカル軸を使うというヒント情報
  * 例えば vc であれば親指のロールをGUIで設定することも可能だと思う
  * vroid の指や足が変になる件

