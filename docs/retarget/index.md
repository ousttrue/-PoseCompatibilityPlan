# retarget

## 骨格とは

* {term}`Joint` の集合。
* 各 joint の初期姿勢での位置。
* 各 joint の初期姿勢での回転。
* 本記事では {term}`ヒューマノイド` 骨格 のみを扱います。

## ポーズとは

* 各 joint の初期姿勢からの回転差分。
* root joint の初期姿勢からの移動。
* 本記事では root(hips) のみが移動し、他の joint は回転のみとします。

## retarget とは

* 体格、初期姿勢が異なるヒューマノイド間で同じ姿勢になるようにポーズを変換する。

## joint から bone への拡張

* すべてのjoint を head-tail のペアにしてロール軸を確定。
* 追加のupベクトルも明示することで３次元姿勢を一意にする。

ボーンが `人間の骨` と解釈できるようにする。

## 曖昧なTPose

* {term}`TPose` から初期姿勢でのヒューマンボーンの向きが `だいたい` わかる

故に TPose に変換してから同じ {term}`Pose` を適用することで同じ姿勢ということにしてた。
TPose 時に

* 親指が斜め
* 肩の上がり下がり具合
* 足が内股、蟹股、開き具合
* 猫背、反り腰

等の TPose 時の個体差が混入する。

## 厳格な TPose の定義を作ろう

TPose から ヒューマンボーン の向きを確定できるように作った。

```{figure} logic.jpg
すべてのボーンが `完全に` ワールド軸平行
```

[ヒューマンボーン](../humanbone/index)

## これではモデルの個性が失われるのでは ?

* 曖昧TPose から 厳格TPose への差分を pose として得ることができるのでこれを加味すればよい(たぶん)
* ポーズに姿勢の個性が入っているか否かで切り分けできるかもしれない
* アプリ内で内部変換用に使うもので、この状態でエクスポートすることは想定していません

## 姿勢は、`骨格とポーズの組` で表される

例えば、mmd の vpdポーズを厳格TPose化する例

```
pmd + vpd
= (pmd - pmdの姿勢の個性) + (vpd + pmdの姿勢の個性)
= 厳格TPoseに変換されたpmd + 厳格Tposeに対するポーズ
```

という感じを想定している。

骨格とポーズのどちらかに `姿勢の個性` が入っていればよくて、
厳格TPose になる前は、両方に `姿勢の個性` が含まれていた。

ポーズの由来によって、骨格側に姿勢の個性が入っていることが期待されるか変わると思う。

| 由来                                                        |                                              |
| ----------------------------------------------------------- | -------------------------------------------- |
| モーションキャプチャー(もともと厳格TPoseに近いのではないか) | 骨格に姿勢の個性入ってないほうがよいのでは？ |
| 手付ポーズを厳格TPoseに変換したもの                         | ポーズ側に個性入っているはず                 |
| ある骨格専用のポーズ                                        | 違う骨格(厳格TPose含む)では変わる            |

骨格とポーズの組を帰ることが許されるか否かで判断。

## 同体格に対するリターゲット

同じ体格で `初期姿勢`, `ローカル軸` の座標変換を行う。
リターゲットシステムに暗黙に含まれるという感じになるかもしれない。
本記事では、リターゲットに含めないことにしたい。
変換と呼ぼう。

## 体格差に対するリターゲット

狭義のリターゲット。
体格差のある骨格にポーズを転送すること。
このときに、ポーズを `いい感じ！` に加工する。
`異なる体格の厳格TPose間でのポーズ転送` だけをリターゲットと呼ぼう。

本記事ではポーズを無加工でコピーすることを想定しているが、
接地のために `hips` のだけは、初期姿勢での高さを基準に位置をスケールすることを想定している。

```{graphviz}
digraph tpose {
    graph [
        rankdir = LR
    ];

    src -> src_tpose [
        style = "dashed",
        label = "座標変換"
    ];
    src_tpose -> dst_tpose [
        label = "体格差retarget"
    ];
    dst_tpose -> dst [
        style = "dashed",
        label = "座標変換"
    ];
}
```

## 厳格Tpose を介した retarget まとめ

* 厳格TPose は 曖昧TPose や Aスタンスからプログラムで機械的に作れる。
  * 納品物は曖昧TPoseでよい。
  * Aスタンスでも良い。
  * どんなポーズでもよいか？
    * ヒューマンボーンの割当がわかればよい。
    * 左右非対称であるとかメカニムの0ポーズはやめたほうがいい気はする。
* すべてのヒューマンボーンの向きが完全に確定する。
  * 厳格TPose == ヒューマンボーンの向き。
* 曖昧だった親指を補正する余地が生まれる。
    * プログラムからの入力ポーズが厳格TPoseに対してずれている、そもそも無理な方向に可動している(親指の第2, 3関節に対して yaw, roll してる)。
    * 受け入れ側のモデルのロール軸が厳格TPoseに対してずれている。
    * 切り分ける。

```{figure} thumb.gif
他モデルリターゲット例。親指の補正(ポーズあるいは骨格)を実験する予定。
```

* 厳格TPose に対するポーズ(回転差分)を、ポーズの標準フォーマットにできるのでは？
    * 便利な bvh。
    * mmd とは路線が異なる。mmd はリグに対するキーフレームアニメーションなのでレイヤーが異なる。
        * FK のポーズが想定されるので下のレイヤー。
* 厳格TPose を作るのに、ヒューマンボーンの先端を示す empty joint が追加で必要(head, toes, 各指)
* 親指などの斜めなボーンを厳格TPose化する際に、ポールターゲットもしくはローカル軸を使うというヒント情報が欲しい。
  * 例えば vc であればアバターをロードしたあとで、ユーザーが自ら、親指のロールをGUIで設定することも可能だと思う。
  * vroid の指や足が変になる問題。
